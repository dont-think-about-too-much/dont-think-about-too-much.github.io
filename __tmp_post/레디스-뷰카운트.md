---
layout: post
title: [Redis] 조회수 +1을 매번 DB 요청할순 없자나/ Write Back Cache
tags: [Nodejs, infra, cache, scaling, Redis]
---

>viewCount를 최적화하는 전반적인 흐름일뿐 Best Practice가 아님을 주의!

이전 레디스 글에서는 자주 읽히는 데이터를 캐싱하는 방법에 대해 알아봤다. 이번에는 조회수를 캐싱하는 방법에대해 알아본다. 

거의 대부분의 서비스에서 조회수라는 개념이 있다. 그런데 사용자가 엄청나게 많아진다면. 유저가 접근한 만큼 DB를 들러 viewCount를 +1 시켜줘야한다. 그렇게 되면 조회수를 수정하는데에 엄청난 자원이 들게 된다. 조회수 라는 데이터가 엄청나게 중요한 데이터가 아닌데도 그렇게 많은 자원을 쓰게 된다면 다른 더 중요한 DB작업에 나쁜 영향을 미칠수 있다.

이를 위해 Redis 캐시를 이용할수 있다. **`Write Back`** 방법이라고 한다.

## Write Back(Write Behind)
애플리케이션에서 cache에 먼저 데이터를 쓰고 얼마간의 지연후 그 데이터를 데이터베이스에 쓴다.

조회수로 생각해보면 10분동안 조회수를 cache(빠른 작업이 가능한)에 적어두고 매 10분마다 cache에 저장되어있는 조회수를 한번에 데이터베이스(작업이 느린)에 viewCount 수정 요청을 하는 것이다.
 
- 장점: 데이터베이스에 접근하는 횟수가 엄청나게 줄어드므로 성능향상및 비용감소가 된다.

- 단점: Redis가 예기치 않게 꺼지면 데이터를 잃을 수 있다. 그래서 엄청 예민한 데이터는 캐시로 이용하지말아야 한다.

아주 간단한 구현으로 과정만 보고 넘어가보자.
Redis에서 viewCount를 저장하려면 `hash`를 써야한다. 기본으로 쓰던 `key: value`는 스트링만 저장되므로 +1 하는게 안된다.

`viewCounts`라는 헤시 테이블이 있다. 그리고 그 해시 테이블에는 `field: value`로 데이터 ID와 조회수를 저장하려고 한다. field를 조회하는 데이터의 ID로 넣을 것이고, value로 조회수를 넣는다.

## 0. redis 메서드부터 보고가자
- .hset(): 셋팅안하고 바로 `.hincrby()`로 증가시키면 알아서 셋팅이 되어서 오늘 쓸일은 없다. .hset("newhash", "field1", 0);
- .hincrby(): 입력하는 숫자만큼 증가한다. .hincrby("newhash", "field1", 1);
- .hdel(): 필드를 지운다. .hdel("newbash", "field1");
- .hget(): 필드 값을 가져온다. .hget("newbash", "field1");


## 1. 조회수 +1 을 캐시에 쓴다. (DB에 쓰지않는다.)
아래는 특정 글을 읽어오는 API이다.(post읽어오는 것도 캐싱을 설정해야하는데 이건 넘어가자.)
```ts
@route('/post/:id')
@GET()
@before([])
async getArtistDetail(ctx: Koa.Context) {
    const postID = ctx.params.id;

    // 미리 hash table에 데이터를 세팅해두지 않아도 처음부터 1을 증가시키면 알아서 생성부터 한다.
    await this.hincrby("viewCounts", `${postID}`, 1)

    const results = await ArtistService.getPost(postID);

    ctx.response.status = HttpStatus.OK;
    ctx.response.body = {
        pagination: results.pagination,
        data: result
    };
}
```
이렇게 매번 읽어올 때마다 DB에 조회수 `+1`을 요청하지 않고 `cache`에 저장해둔다.

<br>

## cache에 모인 조회수를 일정시간마다 DB에 쓴다.
`cron`을 이용하여 레디스에서 조회수를 가져온 뒤 조회수를 한번에 올려주는 API요청 혹은 DB요청을 한다.
```ts

node scheduler 이용

```
## 마지막으로 일정시간동안 저장된 조회수를 삭제한다.
.hdel() 메서드를 이용한다.

<br><br>

## References
- [stackoverflow /redis as write-back view count cache for mysql](https://stackoverflow.com/questions/16761898/redis-as-write-back-view-count-cache-for-mysql)
- [Redis를 사용한 View Count, 방문자 수 관리하는 효과적인 방법은?](https://webisfree.com/2017-11-13/redis%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C-view-count-%EB%B0%A9%EB%AC%B8%EC%9E%90-%EC%88%98-%EA%B4%80%EB%A6%AC%ED%95%98%EB%8A%94-%ED%9A%A8%EA%B3%BC%EC%A0%81%EC%9D%B8-%EB%B0%A9%EB%B2%95%EC%9D%80)
- [HINCRBY key field increment](https://redis.io/commands/HINCRBY)